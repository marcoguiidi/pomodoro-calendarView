<%- include('partials/header'); -%>

<!-- <link type="text/css"
            rel="stylesheet"
            href ="../public/style.css" /> -->
<style>

#resultList {
    position: absolute;
    top: 100%; /* Aligns directly below the input */
    left: 0;
    right: 0;
    z-index: 1050; /* Keeps it on top of other content */
    background: white;
    border: 1px solid #ccc;
    border-radius: 0 0 .25rem .25rem; /* Rounded corners on the bottom */
    box-shadow: 0 4px 6px rgba(0,0,0,.1); /* Subtle shadow for depth */
    max-height: 300px; /* Limit the height and make it scrollable */
    overflow-y: auto;
}

#searchForm .form-control {
    border-radius: .25rem .25rem 0 0; /* Rounded corners on the top */
}

.list-group-item-action:hover {
    background-color: #f8f9fa; /* Light grey background on hover */
    color: #0056b3; /* Change text color slightly */
}

html {
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    line-height: 1.4;
    font-weight: 400;
  }
  
  body {
    background-color: #ccc;
    margin: 0;
  }
  
  header {
    height: 10vh;
    color: gray;
  }
  
  section {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
  }
  
  h1 {
    text-align: center;
  }
  
  article {
    flex: 1 1 500px;
    border: 2px solid red;
    border-radius: 10px;
    background-color: white;
    width: 80%;
    margin: 1rem;
    padding: 5px;
    margin-right: 1vw;
    margin-left: 1vw;
  }
  
  .calendar {
    display: grid;
    grid-template-columns: repeat(7, calc(110% / 7));
    gap: 0.5px;
    width: 90%;
  }
  
  .calendar > div {
    padding: 10px;
    text-align: center;
    justify-content: center;
  }
  
  .calendar > div:not(:nth-last-child(-n+7)) {
    border-bottom: 1px solid rgba(128, 128, 128, 0.278); /* Aggiunge un bordo inferiore alle celle tranne nell'ultima riga */
  }
  
  .month {
    text-align: center;
    color: red;
  }
  
  .day {
    color: red;
    font-size: 80%;
  }
  
  .header {
    color: white !important;
    background-color: red !important;
    font-size: 80%;
  }
  
  .day button {
    border: 0;
    width: fit-content;
    height: 4.5ch;
    border-radius: 20%;
    background-color: transparent;
    color: red;
    font-size: 90%;
  }
  
  @media  (min-width: 600px) {
    .day {
      color: red;
      font-size: 100%;
    }
  
    .day button {
      border: 0;
      width: 4.5ch;
      height: 4.5ch;
      border-radius: 20%;
      background-color: transparent;
      color: red;
      font-size: 100%;
    }
  }
  
  .day button:hover,
  .day button:focus {
    outline: none;
    background-color: lightblue;
    color: #ffffff;
  }
  
  .day button:active {
    background-color: rgb(45, 144, 177);
    color: #ffffff;
  }
  
  .day button.has-event {
    border: 2px dashed;
  }
  
  /* Style for when the button is hovered over */
  .day button.has-event:hover,
  .day button.has-event:focus {
    color: #FFFFFF; /* White text for readability */
  }
  
  dialog {
    border: 2px solid #ff0000; /* Match the calendar border */
    border-radius: 8px; /* Match the calendar border-radius */
    padding: 20px; /* Spacing inside the dialog */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional: Add a subtle shadow for depth */
    margin: auto; /* Center the dialog in the page */
    
    background-color: #fff; /* Match the calendar background color */
    min-width: 15vw; /* Minimum width
    max-width: 75vw; /* Adjust the width */
    max-height: 80vh;
  }
  /* Style for the form within the dialog to align with the calendar's content */
  dialog form {
    display: flex;
    flex-direction: column; /* Stack form elements vertically */
  }
  
  /* Style for the title in the dialog */
  dialog h2 {
    color: red; /* Match the calendar text color */
    margin-top: 0; /* Reduce space above the title */
  }
  
  /* Style for paragraphs and list within the dialog */
  dialog p, dialog ul {
    color: #4A4A4A; /* Match the calendar text color */
    font-size: 95%; /* Slightly smaller text within the dialog */
  }
  
  /* Style for the list of participants */
  dialog ul {
    padding-left: 20px; /*Indent the list */
  } 
  
  /* Style for the close button within the dialog */
  dialog button {
    align-self: flex-end; /* Position the button to the right */
    margin-top: 20px; /* Space above the button */
    padding: 5px 15px; /* Padding inside the button */
    background-color: #ff0000; /* Button background color to match the calendar theme */
    color: white; /* Text color for the button */
    border: none; /* Remove the default border */
    border-radius: 4px; /* Rounded corners for the button */
    cursor: pointer; /* Change cursor to pointer on hover */
  }
  
  /* Hover effect for the button */
  dialog button:hover {
    background-color: #b30000; /* Darker shade on hover */
  }



</style>

<header>
    <h1 >Calendar App</h1>
</header>

<section>
  <dialog id="eventDialog">
      <form method="dialog">
        <h2 id="dialogEventTitle"></h2>
        <p id="dialogEventDate"></p>
        <p id="dialogEventLocation"></p>
        <ul id="dialogEventParticipants"></ul>
        <button value="close">X</button>
        <!-- <button value="delete">üóëÔ∏è</button>     <!-- non funziona -->
      </form>
  </dialog>
  <!-- <article>
      <div style="margin: 20px">
          <h2>Marzo 2024</h2>
          <p>Il calendario qui a destra √® stato realizzato usando il sistema Grid di CSS. Al contrario, l'allineamento dell'header e dei due main √® stato realizzato usando le propriet√† Flex.</p>
          <ul>
              <li>La pseudo-class <b>:hover</b> consente di modificare dello stile quando si passa il mouse sulle date.</li>
              <li>La pseudo-class <b>:focus</b> consente di modificare lo stile quando si clicca su un elemento come un input o un bottone.</li>
              <li>La pseudo-class <b>:active</b> serve per dare feedback all'utente che un elemento ha ricevuto un evento come un click.</li>
          </ul>
      </div>
  </article> -->
  <article>
      <h2 class="month" id="currentMonth"></h2>
      <button id="prevMonthButton">&lt;</button><button id="nextMonthButton">&gt;</button>
      <div class="calendar">
          <div class="header">S</div>
          <div class="header">M</div>
          <div class="header">T</div>
          <div class="header">W</div>
          <div class="header">T</div>
          <div class="header">F</div>
          <div class="header">S</div>

          <div class="day">
            <button></button>
          </div>
          <div class="day">
            <button></button>
          </div>
          <div class="day">
            <button></button>
          </div>
          <div class="day">
            <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button> </button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button> </button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
          <div class="day">
              <button></button>
          </div>
        
        <div class="day" id="sixth">
            <button></button>
        </div>
        <div class="day" id="sixth">
            <button></button>
        </div>
        <div class="day" id="sixth">
            <button></button>
        </div>
        <div class="day" id="sixth">
            <button></button>
        </div>
        <div class="day" id="sixth">
            <button></button>
        </div>
        <div class="day" id="sixth">
            <button></button>
        </div>
        <div class="day" id="sixth">
            <button></button>
        </div>
      </div>
  </article>
  <button><a href="/compose">Add Event</a></button>
</section>
<!-- <script src="../public/util.js" type="text/javascript" async defer></script> -->
<script>
    document.addEventListener('DOMContentLoaded', function() {  // When the DOM is ready...

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth(); // Nota: i mesi in JavaScript sono indicizzati da 0 a 11

    // Funzione per ottenere il nome del mese dato il suo indice
    function getMonthName(monthIndex) {
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        return months[monthIndex];
    }

    // Funzione per generare i giorni del calendario per un dato mese e anno
    function generateCalendarDays(year, month) {
        const firstDayOfMonth = new Date(year, month, 1).getDay(); // Ottieni il giorno della settimana del primo giorno del mese
        const numDays = getDaysInMonth(year, month); // Ottieni il numero totale di giorni nel mese
        let days = [];

        // Aggiungi giorni vuoti prima del primo giorno del mese per allineare correttamente il calendario
        for (let i = 0; i < firstDayOfMonth; i++) {
            days.push(''); // Aggiungi un elemento vuoto per ogni giorno vuoto nella settimana prima del primo giorno del mese
        }

        // Aggiungi i giorni del mese al calendario
        for (let i = 1; i <= numDays; i++) {
            days.push(i); // Aggiungi il giorno corrente al calendario
        }

        for (let i = 0; i < 20; i++) {
            days.push(''); // Aggiungo 20 vuoti perch√® non ho vogglia di fare il calcolo dei giorni vuoti rimanenti
        }

        return days;
    }

    function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate(); // Ottieni il numero di giorni del mese
    }

    

    // Aggiungere un event listener al pulsante del mese precedente
    document.getElementById('prevMonthButton').addEventListener('click', function() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        updateCalendar();
    });

    // Aggiungere un event listener al pulsante del mese successivo
    document.getElementById('nextMonthButton').addEventListener('click', function() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        updateCalendar();
    });
    updateCalendar();

    // Funzione per aggiornare il calendario con il mese e l'anno correnti
    function updateCalendar() {
        const calendarDays = generateCalendarDays(currentYear, currentMonth);
        const dayElements = document.querySelectorAll('.day button');
        const currentMonthElement = document.getElementById('currentMonth');

        // Popolare dinamicamente i giorni del calendario nel markup HTML e rende visibili solo i button che hanno una data associata
        dayElements.forEach((button, index) => {
            if (index < 42 && calendarDays[index] != '') {
                let month = currentMonth+1 < 10 ? `0${currentMonth+1}`: currentMonth + 1;
                let day = calendarDays[index] < 10 ? `0${calendarDays[index]}`: calendarDays[index];
                button.innerHTML = `<time datetime="${currentYear}-${month}-${day}">${calendarDays[index]}</time>`;
                button.style.visibility = 'visible';
            }else if (calendarDays[index] == '') {
                //nascondo dalla visualizzazione in pulsanti inutili
                button.innerHTML = '';
                button.style.visibility = 'hidden';
            }});

        

        // Aggiornare il nome del mese nell'header
        currentMonthElement.textContent = `${getMonthName(currentMonth)} ${currentYear}`;
    
        const dialog = document.getElementById("eventDialog");

        function CB(isevent) {

            document.getElementById('dialogEventTitle').innerHTML = isevent.description; // Set the title
            document.getElementById('dialogEventDate').innerHTML = "Date: " + isevent.date.split('T')[0]; // Set the date
            document.getElementById('dialogEventLocation').innerHTML = "Location: " + isevent.location; // Set the location
            let parts = document.getElementById('dialogEventParticipants'); // Set the participants
            parts.innerHTML = "Participants: ";
            isevent.participants.forEach(function(participant){ // Loop through the participants
                let li = document.createElement('li'); 
                li.innerHTML = participant; // Add the participant to the li element
                parts.appendChild(li); // Append the participant to the list
            })

            dialog.showModal(); 
        }

        fetch('/events') // Fetch events
        .then(response => response.json()) 
        .then(events => {
            const dateButtons = document.querySelectorAll('.day button'); // Get all the date buttons

            dateButtons.forEach(button => {
            if(button.textContent != ''){
                const date = button.querySelector('time').getAttribute('datetime');
                const isevent = events.find(isevent => isevent.date && isevent.date.split('T')[0] == date);

                if (isevent) {
                    const root = document.documentElement;
                    button.classList.add('has-event');
                    button.style.borderColor = isevent.color;

                    // Definiamo una chiusura per memorizzare l'event listener corrente
                    const actualEventHandler = (function(isevent) {
                        return function(event) {
                            CB(isevent);
                        };
                    })(isevent);

                    // Rimuoviamo l'event listener precedente se esiste
                    if (button.eventListener) {
                        button.removeEventListener('click', button.eventListener);
                    }
                    button.addEventListener('click', actualEventHandler);
                    // Memorizziamo l'event listener associato al pulsante
                    button.eventListener = actualEventHandler;
                } else {
                    // Rimuoviamo l'event listener se il pulsante non ha un evento associato
                    if (button.eventListener) {
                        button.removeEventListener('click', button.eventListener);
                        delete button.eventListener; // Rimuoviamo il riferimento all'event listener dal pulsante
                    }
                    button.classList.remove('has-event');
                    button.style.borderColor = 'transparent';
                }       
            }
        });

        })
        .catch(error => console.error('Error loading events:', error)); // Handle any errors
    

        // Clear all components when the form is submitted/closed
        dialog.querySelector('form').onsubmit = function() {
            dialog.close();
        };
    }

    //non funziona delete event listener
    // const deleteButton = document.querySelector('#deleteEventForm button[type="submit"]');
    // if (deleteButton){
    //     deleteButton.addEventListener('click', function() {
    //         // Ottieni l'ID dell'evento corrente dal modal
    //         const eventID = this.getAttribute('data-event-id');
            
    //         // Ottieni l'ID dell'utente corrente
            
    //         // Costruisci l'URL con i parametri dell'utente e dell'evento
    //         const deleteURL = `/events/${eventID}/delete`;
            
    //         // Modifica l'attributo action del form con l'URL corretto
    //         const deleteForm = document.getElementById('deleteEventForm');
    //         deleteForm.action = deleteURL;

    //         // Sottometti il form
    //         deleteForm.submit();
    //     })
    // };
  });

</script>


<%- include('partials/footer'); -%>
